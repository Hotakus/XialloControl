<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XenoControl</title>
  <style>
      :root {
          --primary-bg: #2f3542;
          --primary-text: #ffffff;
          --secondary-bg: #f7f9fb;
          --card-bg: #ffffff;
          --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          --border-radius: 10px;
          --gap: 20px;
          --active-shadow: 0 0 15px rgba(0, 0, 0, 0.3) inset;
      }

      * {
          box-sizing: border-box;
      }

      body {
          margin: 0;
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          background: transparent;
          color: #333;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          -webkit-app-region: nodrag;
      }

      .window {
          width: 1280px;
          height: 720px;
          background: #ffffff;
          border-radius: var(--border-radius);
          box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
          overflow: hidden;
          display: flex;
          flex-direction: column;
      }

      .window-header {
          height: 48px;
          background: var(--primary-bg);
          color: var(--primary-text);
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0 10px;
          user-select: none;
          -webkit-app-region: drag;
          border-radius: var(--border-radius) var(--border-radius) 0 0;
      }

      .header-left {
          display: flex;
          align-items: center;
          gap: 8px;
          font-weight: bold;
          font-size: 18px;
      }

      .header-left img {
          height: 24px;
          width: 24px;
      }

      .window-header button {
          background: transparent;
          border: none;
          color: var(--primary-text);
          font-size: 18px;
          margin-left: 10px;
          cursor: pointer;
          -webkit-app-region: no-drag;
          padding: 4px 8px;
          border-radius: 50%;
          transition: all 0.15s ease;
      }

      .window-header button:hover {
          background: rgba(255, 255, 255, 0.2);
          transform: scale(1.1);
      }

      #minimize-button:hover {
          background: rgba(255, 255, 255, 0.2);
      }

      #close-button:hover {
          background: #e81123;
          color: white;
      }

      /* å¢å¼ºæŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
      .window-header button:active {
          transform: scale(0.85);
          background-color: rgba(255, 255, 255, 0.4);
          box-shadow: var(--active-shadow);
          color: #fff;
          transition: none;
      }

      #close-button:active {
          background-color: #c00000 !important;
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.5) inset !important;
      }

      .window-body {
          flex: 1;
          display: flex;
          min-height: 0;
          padding: 0 var(--gap);
      }

      .left-panel {
          flex: 6;
          background: var(--secondary-bg);
          padding: var(--gap);
          display: flex;
          flex-direction: column;
          gap: var(--gap);
          min-height: 0;
          border-radius: 0;
      }

      .right-panel {
          flex: 4;
          padding: var(--gap);
          background: var(--card-bg);
          display: flex;
          flex-direction: column;
          gap: var(--gap);
          min-height: 0;
          border-radius: 0;
      }

      .card {
          background: var(--card-bg);
          border-radius: var(--border-radius);
          box-shadow: var(--card-shadow);
          padding: 15px 20px;
      }

      .preset-card {
          height: auto;
          min-height: auto;
          display: flex;
          flex-direction: column;
      }

      .preset-controls {
          display: flex;
          gap: 8px;
          margin-top: 10px;
      }

      .preset-controls button {
          flex: 1;
          padding: 8px;
          border: none;
          border-radius: 6px;
          background-color: #4c8bf5;
          color: white;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.15s ease;
      }

      .preset-controls button:hover {
          background-color: #3a7de0;
          transform: translateY(-1px);
      }

      /* å¢å¼ºé¢„è®¾æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
      .preset-controls button:active {
          transform: translateY(1px);
          background-color: #2a5dbf;
          box-shadow: var(--active-shadow);
          transition: none;
      }

      .right-panel .card:not(.preset-card) {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-height: 0;
          overflow: hidden;
      }

      .controller-image {
          flex: 1;
          background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect x='20' y='40' width='160' height='120' rx='20' fill='%23333'/%3E%3Ccircle cx='60' cy='80' r='15' fill='%23fff'/%3E%3Ccircle cx='140' cy='80' r='15' fill='%23fff'/%3E%3Crect x='80' y='110' width='40' height='20' rx='5' fill='%23fff'/%3E%3C/svg%3E") center/contain no-repeat;
          border-radius: var(--border-radius);
          min-height: 0;
      }

      .tabs {
          display: flex;
          border-bottom: 2px solid #e0e4eb;
          margin-bottom: 10px;
          user-select: none;
      }

      .tab {
          padding: 8px 16px;
          cursor: pointer;
          font-weight: bold;
          color: #555;
          border-radius: 6px 6px 0 0;
          background-color: #f1f3f6;
          margin-right: 8px;
          transition: background-color 0.2s;
      }

      .tab.active {
          background-color: #ffffff;
          color: #2f3542;
          box-shadow: 0 -2px 0 0 #2f3542 inset;
      }

      .tab:hover:not(.active) {
          background-color: #dce2ea;
      }

      .tab-content {
          display: none;
          flex-direction: column;
          height: 100%;
          min-height: 0;
          flex: 1;
      }

      .tab-content.active {
          display: flex;
      }

      .button-map,
      .stick-map {
          flex-grow: 1;
          overflow-y: auto;
          padding-right: 5px;
          display: flex;
          flex-direction: column;
          gap: 8px;
          min-height: 0;
      }

      .button-map-item {
          display: flex;
          align-items: center;
          gap: 12px;
          background: #f1f3f6;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 14px;
          white-space: nowrap;
      }

      .button-icon {
          display: flex;
          justify-content: center;
          align-items: center;
          width: 28px;
          height: 28px;
          background: #e0e4eb;
          border-radius: 6px;
          font-weight: bold;
          font-size: 16px;
          user-select: none;
          flex-shrink: 0;
      }

      .key-text {
          color: #555;
      }

      .window-footer {
          height: 36px;
          background: var(--primary-bg);
          color: var(--primary-text);
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0 15px;
          font-size: 14px;
          user-select: none;
      }

      .window-footer a {
          color: #9ec6ff;
          text-decoration: none;
          margin-left: 10px;
      }

      .window-footer a:hover {
          text-decoration: underline;
      }

      label {
          font-weight: bold;
          margin-bottom: 5px;
          display: inline-block;
      }

      select {
          width: 100%;
          padding: 10px;
          font-size: 14px;
          border-radius: 8px;
          border: 1px solid #ccc;
          background-color: #f8f9fa;
          appearance: none;
          background-image: url("data:image/svg+xml,%3Csvg width='10' height='7' viewBox='0 0 10 7' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 6L9 1' stroke='%23666' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 10px center;
          background-size: 12px;
      }

      select:focus {
          outline: none;
          border-color: #4c8bf5;
          box-shadow: 0 0 0 2px rgba(76, 139, 245, 0.3);
      }

      .indicator-container {
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .indicator-label {
          font-size: 12px;
          color: #9ec6ff;
      }

      .indicator {
          width: 100px;
          height: 14px;
          border-radius: 7px;
          background-color: #5c0000;
          position: relative;
          transition: all 0.3s ease;
          box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
      }

      .indicator.on {
          background-color: #90ee90;
          box-shadow: 0 0 6px rgba(144, 238, 144, 0.8),
          inset 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      @media (max-width: 768px) {
          .window {
              width: 100%;
              height: 100%;
              border-radius: 0;
          }

          .window-body {
              flex-direction: column;
          }

          .indicator-container {
              display: none;
          }
      }

      .indicator-test-btn {
          background: rgba(158, 198, 255, 0.2);
          color: #9ec6ff;
          border: 1px solid rgba(158, 198, 255, 0.5);
          border-radius: 4px;
          padding: 2px 8px;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.2s;
          margin-left: 5px;
      }

      .indicator-test-btn:hover {
          background: rgba(158, 198, 255, 0.3);
      }

      /* å¢å¼ºæµ‹è¯•æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
      .indicator-test-btn:active {
          transform: scale(0.95);
          background: rgba(158, 198, 255, 0.4);
          box-shadow: var(--active-shadow);
          transition: none;
      }

      .device-select-row {
          display: flex;
          gap: 10px;
          align-items: center;
      }

      .device-select-row select {
          flex: 1;
      }

      #scan-button {
          padding: 8px 12px;
          background-color: #4c8bf5;
          color: white;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.15s ease;
          white-space: nowrap;
      }

      #scan-button:hover {
          background-color: #3a7de0;
          transform: translateY(-1px);
      }

      /* å¢å¼ºæ‰«ææŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
      #scan-button:active {
          transform: translateY(1px);
          background-color: #2a5dbf;
          box-shadow: var(--active-shadow);
          transition: none;
      }
  </style>
</head>
<body>
<div class="window">
  <div class="window-header">
    <div class="header-left">
      <span>XenoControl</span>
    </div>
    <div>
      <button id="minimize-button">ğŸ—•</button>
      <button id="close-button">âœ–</button>
    </div>
  </div>

  <div class="window-body">
    <div class="left-panel">
      <div class="card">
        <label for="device">ğŸ® é€‰æ‹©è®¾å¤‡:</label>
        <div class="device-select-row">
          <select id="device">
            <option value="null">è¯·é€‰æ‹©è®¾å¤‡</option>
          </select>
          <button id="scan-button">é‡æ–°æ‰«æ</button>
        </div>
      </div>

      <div class="card controller-image"></div>
    </div>

    <div class="right-panel">
      <div class="card preset-card">
        <label for="preset">ğŸ“‚ é¢„è®¾æ–¹æ¡ˆ:</label>
        <select id="preset">
          <option>é»˜è®¤</option>
          <option>æ¸¸æˆæ¨¡å¼</option>
          <option>åª’ä½“æ§åˆ¶</option>
        </select>
        <div class="preset-controls">
          <button id="save-preset">ä¿å­˜æ–¹æ¡ˆ</button>
          <button id="import-preset">å¯¼å…¥æ–¹æ¡ˆ</button>
        </div>
      </div>

      <div class="card">
        <div class="tabs" role="tablist">
          <div class="tab active" role="tab" aria-selected="true" data-tab="buttonMapTab">æŒ‰é”®è®¾ç½®</div>
          <div class="tab" role="tab" aria-selected="false" data-tab="stickMapTab">æ‘‡æ†æ˜ å°„</div>
        </div>

        <div id="buttonMapTab" class="tab-content active" role="tabpanel">
          <div class="button-map">
            <!-- æŒ‰é”®æ˜ å°„åˆ—è¡¨ä¿æŒä¸å˜ -->
          </div>
        </div>

        <div id="stickMapTab" class="tab-content" role="tabpanel">
          <div class="stick-map">
            <!-- æ‘‡æ†æ˜ å°„åˆ—è¡¨ä¿æŒä¸å˜ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="window-footer">
    <div class="indicator-container">
      <span class="indicator-label">è¿æ¥çŠ¶æ€</span>
      <div id="status-indicator" class="indicator"></div>
      <button id="indicator-test-btn" class="indicator-test-btn">æµ‹è¯•</button>
    </div>

    <div>
      <span>Â© 2025 XenoControl</span>
      <a id="github-link" href="https://github.com/hotakus" target="_blank" rel="noopener noreferrer" title="GitHub ä»“åº“">GitHub</a>
    </div>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const appWindow = window.__TAURI__.window.getCurrentWindow();
        const invoker = window.__TAURI__.core.invoke;

        // é‡æ–°æ‰«ææŒ‰é’®
        const scanButton = document.getElementById('scan-button');
        scanButton.addEventListener('click', async () => {
            hasUserSelectedDevice = false;

            try {
                await invoker("query_devices");
            } catch (e) {
                console.error("é‡æ–°æ‰«æå¤±è´¥:", e);
            }
        });

        const deviceSelect = document.getElementById('device');
        let hasUserSelectedDevice = false;  // ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†è®¾å¤‡
        let currentDevices = [];            // å½“å‰æ˜¾ç¤ºçš„è®¾å¤‡åˆ—è¡¨ç¼“å­˜

        // ç›‘å¬ç”¨æˆ·é€‰æ‹©è¡Œä¸º
        deviceSelect.addEventListener('change', function () {
            if (this.value !== "null") {
                hasUserSelectedDevice = true;
            }
            console.log('Selected device:', this.value);
        });

        appWindow.listen('update_devices', (event) => {
            const devices = event.payload;

            // å¦‚æœè®¾å¤‡åˆ—è¡¨ä¸º 0ï¼Œå¼ºåˆ¶é‡ç½®é€‰æ‹©çŠ¶æ€
            if (devices.length === 0) {
                hasUserSelectedDevice = false;
            }

            // å¦‚æœç”¨æˆ·å·²é€‰æ‹©è®¾å¤‡ï¼Œè·³è¿‡åˆ·æ–°
            if (hasUserSelectedDevice) {
                toggleIndicator(devices.length > 0);
                return;
            }

            // å¦‚æœè®¾å¤‡åˆ—è¡¨æ²¡æœ‰å˜åŒ–ï¼Œä¹Ÿä¸åˆ·æ–°
            if (currentDevices === devices) {
                return;
            }

            currentDevices = devices;
            console.log("è®¾å¤‡åˆ—è¡¨ï¼š", currentDevices);

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            deviceSelect.innerHTML = '';

            // æ·»åŠ é»˜è®¤é€‰é¡¹
            const defaultOption = document.createElement('option');
            defaultOption.textContent = 'è¯·é€‰æ‹©è®¾å¤‡';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            deviceSelect.appendChild(defaultOption);

            // æ·»åŠ è®¾å¤‡é€‰é¡¹
            devices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = index;
                // option.textContent = `${device.name} (VID: ${device.vendor_id.toString(16)}, PID: ${device.product_id.toString(16)})`;
                option.textContent = `${index}: ${device.name}`
                deviceSelect.appendChild(option);
            });

            // æ›´æ–°è¿æ¥çŠ¶æ€
            toggleIndicator(devices.length > 0);
        });

        // å‡½æ•°å°è£…ï¼šçª—å£æ§åˆ¶
        async function windowControl(action) {
            if (window.__TAURI__) {
                await invoker(action);
            } else {
                console.log(`${action} simulated`);
            }
        }

        // å‡½æ•°å°è£…ï¼šåˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabElement) {
            const targetTab = tabElement.dataset.tab;

            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
            });

            // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
            tabElement.classList.add('active');
            tabElement.setAttribute('aria-selected', 'true');
            document.getElementById(targetTab).classList.add('active');
        }

        // äº‹ä»¶å§”æ‰˜å¤„ç†é€‰é¡¹å¡åˆ‡æ¢
        document.querySelector('.tabs').addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (tab) switchTab(tab);
        });

        // çª—å£æ§åˆ¶æŒ‰é’®
        document.getElementById('minimize-button').addEventListener('click', () =>
            appWindow.minimize());

        document.getElementById('close-button').addEventListener('click', () =>
            appWindow.hide());

        // è®¾å¤‡é€‰æ‹©é€»è¾‘
        document.getElementById('device').addEventListener('change', function () {
            console.log('Selected device:', this.value);
        });

        // é¢„è®¾æ–¹æ¡ˆé€‰æ‹©é€»è¾‘
        document.getElementById('preset').addEventListener('change', function () {
            console.log('Selected preset:', this.value);
        });

        // ä¿å­˜å’Œå¯¼å…¥æŒ‰é’®ï¼ˆä»…æ ·å¼ï¼Œæ— åŠŸèƒ½ï¼‰
        document.getElementById('save-preset').addEventListener('click', function () {
            console.log('ä¿å­˜æ–¹æ¡ˆ');
        });

        document.getElementById('import-preset').addEventListener('click', function () {
            console.log('å¯¼å…¥æ–¹æ¡ˆ');
        });

        // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­æ¨¡æ‹ŸTauri API
        if (!window.__TAURI__) {
            console.warn('Running in browser mode - Tauri API not available');
        }

        // è·å–æŒ‡ç¤ºç¯å…ƒç´ 
        const indicator = document.getElementById('status-indicator');

        // æŒ‡ç¤ºç¯æ§åˆ¶å‡½æ•°
        function toggleIndicator(isOn) {
            if (isOn) {
                indicator.classList.add('on');
            } else {
                indicator.classList.remove('on');
            }
        }

        // å°†æ§åˆ¶å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.toggleIndicator = toggleIndicator;

        // åˆå§‹çŠ¶æ€è®¾ä¸ºå…³é—­
        toggleIndicator(false);

        // æŒ‡ç¤ºç¯æµ‹è¯•æŒ‰é’®åŠŸèƒ½
        document.getElementById('indicator-test-btn').addEventListener('click', () => {
            const indicator = document.getElementById('status-indicator');
            const isOn = indicator.classList.contains('on');
            toggleIndicator(!isOn);
        });

        const githubLink = document.getElementById('github-link');
        if (githubLink) {
            githubLink.addEventListener('click', async (e) => {
                // å¦‚æœåœ¨Tauriç¯å¢ƒä¸­
                if (window.__TAURI__) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤æ‰“å¼€æ–¹å¼
                    invoker("open_url", {url: githubLink.href});
                }
                // å¦åˆ™ï¼Œé»˜è®¤è¡Œä¸ºï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰ä¼šæ­£å¸¸è¿›è¡Œ
            });
        }
    });
</script>
</body>
</html>